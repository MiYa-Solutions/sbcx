<% provide(:title, I18n.t('general.general.job_number').html_safe + "#{@service_call.ref_id}" )%>
<div class="well well_height">

<div class="row-fluid">

<div class="no_margins">
  <div class="span4" id="job_statuses_actions">

    <ul class="unstyled" id="block_job_statuses_actions">
      <li>
        <div class="smart_label">
          <ul>
            <li><h1><%=I18n.t('general.general.job_number').html_safe + ": " + "#{@service_call.ref_id}" %></h1></li>
            <li></li>
          </ul>
        </div>
      </li>
      <li>
        <table class="table table-striped table-condensed table-sbcx">
          <tbody>

          <% if !@service_call.started_on_text.blank? %>
              <tr>
                <td>Started at</td>
                <td>
                                  <span class="status_label_success">
                                  <badge id="service_call_started_on_text"><%= @service_call.started_on_text %></badge>
                                  </span>
                </td>
              </tr>
          <% end %>
          <tr>
            <td>Status</td>
            <td>
                                      <span class="status_label" id="service_call_status">
                                      <badge><%= @service_call.human_status_name %></badge>
                                      </span>
            </td>
          </tr>
          <tr>
            <td>Work Status</td>
            <td>
                                      <span class="status_label" id="service_call_work_status">
                                      <badge><%= @service_call.human_work_status_name %></badge>
                                      </span>
            </td>
          </tr>
          <% unless @service_call.subcon_na? %>
              <tr>
                <td>Subcontractor</td>
                <td>
                                      <span class="status_label" id="service_call_subcontractor_status">
                                      <badge><%= @service_call.human_subcontractor_status_name %></badge>
                                      </span>
                </td>
              </tr>
          <% end %>
          <% unless @service_call.provider_status.nil? %>
              <tr>
                <td>Provider</td>
                <td>
                                      <span class="status_label" id="service_call_provider_status">
                                      <badge><%= @service_call.human_provider_status_name %></badge>
                                      </span>
                </td>
              </tr>
          <% end %>
          <% if !@service_call.completed_on_text.blank? %>
              <tr>
                <td>Completed at</td>
                <td>
                                              <span class="status_label" id="service_call_completed_on">
                                              <badge><%= @service_call.completed_on_text %></badge>
                                              </span>
                </td>
              </tr>
          <% end %>
          <tr>
            <td>Billing Status</td>
            <td>
                                              <span class="status_label" id="service_call_billing_status">
                                              <badge><%= @service_call.human_billing_status_name %></badge>
                                              </span>
            </td>
          </tr>
          </tbody>
        </table>
      </li>
    </ul>

    <br>
    <!--<#% if @service_call.status_events.size > 0 %>-->
    <ul class="unstyled">
      <li>
        <div class="smart_label">
          <ul>
            <li><h1>Actions</h1></li>
            <li></li>
          </ul>
        </div>
      </li>
      <li><br></li>
      <li>
        <div class="action_buttons_service_call">
          <p>
            <%= event_list(@service_call) %>
          </p>
        </div>
      </li>
    </ul>
    <!--<#% end %>-->

  </div>
</div>


<!--Job details-->
<div class="span8" id="job_details">
  <%= simple_form_for @service_call, as: :service_call, url: service_call_url(@service_call), :html => { :class => 'form-horizontal' }, :remote => true do |f| %>

      <div class="smart_label">
        <ul>
          <li><h1>Job Name</h1></li>
          <li></li>
          <!--<#% if ! @service_call.started_on_text.blank? %>-->
          <!--<li>-->
          <!--<span>Completed on:</span>-->
          <!--<#%= f.text_field :completed_on_text, class: "datepicker input-medium", placeholder: 'Click to set date' %>-->
          <!--</li>-->
          <!--&lt;!&ndash;<span class="help-inline">Click to set date</span>&ndash;&gt;-->
          <!--<#% end %>-->
          <!--</li>-->
          <% if !@service_call.events.empty? %>
              <li>
                <button type="button" class="btn btn-primary btn-medium" data-toggle="modal" data-target="#myModal">
                  View Job History
                </button>
              </li>
          <% end %>
        </ul>
      </div>
      <br>
      <!--Update Job Info-->
      <div class="row-fluid">

        <div class="span8">
          <ul class="unstyled list_service_calls">

            <% if !@service_call.started_on_text.blank? %>
                <li>
                  <div class="control-group select required">
                    <label class="select optional control-label" for="completed_on_text"><%= @service_call.class.human_attribute_name(:completed_on_text) %></label>

                    <div class="controls">
                      <%= f.text_field :completed_on_text, class: "datepicker", placeholder: 'Click to set date' %>
                    </div>
                  </div>
                </li>
            <% end %>

            <li>
              <div class="control-group string ">
                <label class="string  control-label" for="service_call_started_on"><%= @service_call.class.human_attribute_name(:scheduled_for) %></label>

                <div class="controls">
                  <%= f.text_field :scheduled_for, class: "datepicker", value: f.object.scheduled_for %>

                </div>
              </div>
            </li>

            <li>
              <div id="customer_wrapper">
                <%= f.association :customer, collection: current_user.organization.customers, value: f.object.customer %>
              </div>
            </li>
            <li class="list_service_calls" id="customer_details">
              <address>
                <strong><%= f.object.customer.name %></strong>
                <button class="btn btn-info btn-mini" data-toggle="collapse" data-target="#show_customer_in_service_call" id="show_customer_from_service_call">
                  Edit
                </button>
                <br>
                <%= best_in_place f.object.customer, :address1 %>
                <br>
                <%= f.object.customer.address2 %>
                <br>
                <%= f.object.customer.city %>, <%= f.object.customer.state %> <%= f.object.customer.zip %>
                <br>
                Phone: <%= f.object.customer.phone %>
                <br>
                Mobile: <%= f.object.customer.mobile_phone %>
                <br>
              </address>
            </li>
            <li>
              <address>
                <div id="show_customer_in_service_call" class="collapse">
                  dddd
                </div>
              </address>
            </li>
            <% unless current_user.organization.name == @service_call.subcontractor.try(:name) %>
                <li>
                  <div class="control-group select required">
                    <label class="select optional control-label" for="completed_on_text">Subcontractor</label>

                    <div class="controls">
                      <div class="input-large uneditable-input" title="To change Subcontractor use the action section" rel='tooltip'>
                        <%= f.object.subcontractor.try (:name) %>
                      </div>
                    </div>
                  </div>
                </li>
            <% end %>
            <li>
              <div class="control-group select required">
                <label class="select optional control-label" for="completed_on_text">Technician</label>

                <div class="controls">

                  <div class="input-large uneditable-input" title="To change Technician use the action section" rel='tooltip'>
                    <%= f.object.technician.try(:name) %>
                  </div>

                </div>
              </div>

            </li>
            <li>
              <%= f.association :provider, collection: ([current_user.organization.becomes(Provider)] + current_user.organization.providers), value: f.object.provider, :include_blank => "Me" %>
            </li>
          </ul>

          <!--here-->
        </div>

        <div class="span4" id="job_notes">

          <div class="miya_note_area string mandatory">
            <%= f.input :notes %>
          </div>

        </div>

      </div>

      <div class="form-actions_in_service_call">
        <div class="form-actions">
          <%= link_to "Back", service_calls_path, class: "btn btn-medium" %>
          <%= f.submit "Save Changes", class: "btn btn-medium btn-primary", id: 'service_call_save_btn' %>
        </div>
      </div>
      <!--end of status & Job details section-->

  <% end %>
  <!--Parts-->
  <div class="row-fluid">
    <div class="smart_label">
      <ul>
        <li><h1><%= Material.model_name.human.pluralize %></h1></li>
        <li><%= link_to 'Add Parts', '', :class => 'btn btn-primary', id: 'new-bom-button', data: { toggle: "collapse", target: "#bom" } %></li>
      </ul>
    </div>

    <div class="bom collapse" id="bom">
      <%= render 'boms/in_line_form', ticket: @service_call.becomes(ServiceCall) %>

    </div>

    <table class="table table-striped" id="boms-table">
      <thead>
      <tr>
        <th><%= Bom.human_attribute_name(:material_name) %></th>
        <th><%= Bom.human_attribute_name(:quantity) %></th>
        <th><%= Bom.human_attribute_name(:cost) %></th>
        <th><%= Bom.human_attribute_name(:price) %></th>
        <th><%= Bom.human_attribute_name(:total_cost) %></th>
        <th><%= Bom.human_attribute_name(:total_price) %></th>
        <th>Actions</th>
      </tr>
      </thead>
      <tbody id="boms">

      <% @service_call.boms.each do |bom| %>
          <tr id="bom_<%= bom.id %>">
            <%= render 'boms/bom', bom: bom %>
          </tr>
      <% end %>
      </tbody>
    </table>


  </div>

</div>


<!--Parts-->


<!--End of main row-->
</div>

<!--end of well  -->
</div>

<!--Job History Pop-up-->
<div id="myModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="myModalLabel">Job History</h3>
  </div>
  <div class="modal-body">
    <table class="table table-striped" id="event_log_in_service_call">
      <thead>
      <tr>
        <th><%= Event.human_attribute_name(:name) %> </th>
        <th><%= Event.human_attribute_name(:description) %></th>
        <th>Created at</th>
        <th>Event ID</th>
      </tr>
      </thead>
      <tbody>
      <% @service_call.events.each do |event| %>
          <tr>
            <td>
              <%= event.name %>
            </td>
            <td><%= event.description %></td>
            <td>
              <%= event.created_at %>
            </td>
            <td>
              <%= event.id %>
            </td>
          </tr>
      <% end %>
      </tbody>
    </table>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
  </div>
</div>

<div><%= render 'appointments/add_appointment', appointable: @service_call %></div>

<div class="row-fluid">
  <div class="smart_label">
    <ul>
      <li><h1><%= Appointment.model_name.human.pluralize %></h1></li>
      <li><%= link_to 'Add Appointment', '#', :class => 'btn btn-primary', id: 'new-appointment-button', data: { toggle: "collapse", target: "#appointment" } %></li>
    </ul>
  </div>

  <div class="appointment collapse" id="appointment">
    <%= render 'appointments/in_line_form', appointment: @service_call.appointments.build %>

  </div>

  <table class="table table-striped" id="appointments-table">
    <thead>
    <tr>
      <th>Title</th>
      <th>Description</th>
      <th>Starts At</th>
      <th>Ends At</th>

    </tr>
    </thead>
    <tbody id="appointments">

    <% @service_call.appointments.each do |appointment| %>
        <tr id="appointment_<%= appointment.id %>">
          <%= render 'appointments/appointment', appointment: appointment %>
        </tr>
    <% end %>
    </tbody>
  </table>


</div>
